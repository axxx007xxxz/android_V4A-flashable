#!/sbin/sh
#
# CandyRoms ViPER4Android installer
#
# Thanks Chainfire and osm0sis


OUTFD=/proc/self/fd/$2
ZIP="$3"

ui_print() {
  until [ ! "$1" ]; do
    echo -e "ui_print $1\nui_print" > $OUTFD
    shift
  done
}

cp_perm() {
  cp $1 $2
  chmod $3 $2
}

mount -o ro -t auto /system
mount -o ro -t auto /vendor



if [ ! -f "/sbin/unzip" ]; then
  ui_print "- NO UNZIP FOUND. ABORTING!"
  exit 1
fi

mount -o rw,remount -t auto /system
mount -o rw,remount -t auto /vendor



ui_print "- Extracting files"

TMPDIR=/tmp/v4a
mkdir "$TMPDIR" && cd "$TMPDIR"

if [ ! -d "$TMPDIR" ]; then
  ui_print "- CANNOT CREATE NEEDED DIRECTORY. ABORTING!"
  exit 1
fi

unzip -o "$ZIP"



COM=$TMPDIR/common

test -f /system/system/build.prop && root=/system

rm -f $root/system/etc/audio_effects.conf
rm -f $root/system/vendor/etc/audio_effects.conf
rm -f $root/system/lib/soundfx/libv4a_fx_jb_NEON.so
rm -f /vendor/etc/audio_effects.conf

cp_perm $COM/audio_effects.conf $root/system/etc/audio_effects.conf 0644
cp_perm $COM/libv4a_fx_jb_NEON.so $root/system/lib/soundfx/libv4a_fx_jb_NEON.so 0644

umount /vendor
umount /system
ui_print "Done."
